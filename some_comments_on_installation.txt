------- L D A P -------

apt-get install ldap-utils slapd

Make several changes

Locate File -> 
/etc/ldap/slapd.d/cn=config/olcDatabase={1}mdb.ldif

Change the followings attributes

olcSuffix: dc=deitos, dc=network
olcRootDN: cn=admin,dc=deitos, dc=network

Change Admin Password 
slappasswd

Check all Configuration
slaptest -u

Check configuration
ldapsearch -x -b '' -s base '(objectclass=*)' namingContexts

Create deitos.ldif in /root with this content

dn: dc=deitos,dc=network
objectclass: dcObject
objectclass: organization
o: Deitos Network
dc: deitos

dn: cn=admin,dc=deitos,dc=network
objectclass: organizationalRole
cn: admin

ldapadd -x -D "cn=admin,dc=deitos,dc=network" -W -f /root/deitos.ldif

ldapsearch -x -b 'dc=deitos,dc=network' '(objectclass=*)'


------- K E R B E R O S -------

nano /etc/krb5kdc/kdc.conf 

[kdcdefaults]
    kdc_ports = 750,88

[realms]
    DEITOS.NETWORK = {
        database_name = /var/lib/krb5kdc/principal
        admin_keytab = FILE:/etc/krb5kdc/kadm5.keytab
        acl_file = /etc/krb5kdc/kadm5.acl
        key_stash_file = /etc/krb5kdc/stash
        kdc_ports = 750,88
        max_life = 10h 0m 0s
        max_renewable_life = 7d 0h 0m 0s
        #master_key_type = aes256-cts
        #supported_enctypes = aes256-cts:normal aes128-cts:normal
        default_principal_flags = +preauth
    }




nano /etc/krb5.conf

[libdefaults]
        default_realm = DEITOS.NETWORK

# The following krb5.conf variables are only for MIT Kerberos.
        kdc_timesync = 1
        ccache_type = 4
        forwardable = true
        proxiable = true

# The following encryption type specification will be used by MIT Kerberos
# if uncommented.  In general, the defaults in the MIT Kerberos code are
# correct and overriding these specifications only serves to disable new
# encryption types as they are added, creating interoperability problems.
#
# The only time when you might need to uncomment these lines and change
# the enctypes is if you have local software that will break on ticket
# caches containing ticket encryption types it doesn't know about (such as
# old versions of Sun Java).

#       default_tgs_enctypes = des3-hmac-sha1
#       default_tkt_enctypes = des3-hmac-sha1
#       permitted_enctypes = des3-hmac-sha1

# The following libdefaults parameters are only for Heimdal Kerberos.
        fcc-mit-ticketflags = true

[realms]
        DEITOS.NETWORK = {
                kdc = master
                admin_server = master
                default_domain = deitos.network
        }

[domain_realm]
        master = DEITOS.NETWORK
        worker1 = DEITOS.NETWORK
        worker2 = DEITOS.NETWORK
        history = DEITOS.NETWORK
        jupyter = DEITOS.NETWORK


nano /etc/krb5kdc/kadm5.acl

*/admin@DEITOS.NETWORK        *
*/master@DEITOS.NETWORK               *


kdb5_util create -r DEITOS.NETWORK -s

kadmin.local
addprinc root/admin@DEITOS.NETWORK

service krb5-kdc start
service krb5-admin-server start

service krb5-kdc status
service krb5-admin-server status

kadmin
addprinc hadoop/admin@DEITOS.NETWORK
addprinc jovyan/admin@DEITOS.NETWORK

klist
klist -A
kinit root/admin

sudo -i -u jovyan

kadmin -p jovyan/admin

addprinc hdfs/master@DEITOS.NETWORK
addprinc yarn/master@DEITOS.NETWORK
addprinc mapred/master@DEITOS.NETWORK
addprinc HTTP/master@DEITOS.NETWORK
addprinc hive/master@DEITOS.NETWORK

addprinc hdfs/worker1@DEITOS.NETWORK
addprinc yarn/worker1@DEITOS.NETWORK
addprinc mapred/worker1@DEITOS.NETWORK
addprinc HTTP/worker1@DEITOS.NETWORK
addprinc hive/worker1@DEITOS.NETWORK

addprinc hdfs/worker2@DEITOS.NETWORK
addprinc yarn/worker2@DEITOS.NETWORK
addprinc mapred/worker2@DEITOS.NETWORK
addprinc HTTP/worker2@DEITOS.NETWORK
addprinc hive/worker2@DEITOS.NETWORK

addprinc hdfs/history@DEITOS.NETWORK
addprinc yarn/history@DEITOS.NETWORK
addprinc mapred/history@DEITOS.NETWORK
addprinc HTTP/history@DEITOS.NETWORK
addprinc hive/history@DEITOS.NETWORK

addprinc hdfs/jupyter@DEITOS.NETWORK
addprinc yarn/jupyter@DEITOS.NETWORK
addprinc mapred/jupyter@DEITOS.NETWORK
addprinc HTTP/jupyter@DEITOS.NETWORK
addprinc hive/jupyter@DEITOS.NETWORK

addprinc hdfs/metastore@DEITOS.NETWORK
addprinc yarn/metastore@DEITOS.NETWORK
addprinc mapred/metastore@DEITOS.NETWORK
addprinc HTTP/metastore@DEITOS.NETWORK
addprinc hive/metastore@DEITOS.NETWORK

kadmin -p jovyan/admin -w admin -q " xst -k /opt/hadoop/etc/hadoop/keytabs/hdfs-unmerged.keytab  hdfs/master@DEITOS.NETWORK hdfs/worker1@DEITOS.NETWORK hdfs/worker2@DEITOS.NETWORK hdfs/history@DEITOS.NETWORK hdfs/jupyter@DEITOS.NETWORK hdfs/metastore@DEITOS.NETWORK hive/master@DEITOS.NETWORK hive/worker1@DEITOS.NETWORK hive/worker2@DEITOS.NETWORK hive/history@DEITOS.NETWORK hive/jupyter@DEITOS.NETWORK hive/metastore@DEITOS.NETWORK "

xst -k yarn-unmerged.keytab yarn/master@DEITOS.NETWORK yarn/worker1@DEITOS.NETWORK yarn/worker2@DEITOS.NETWORK yarn/history@DEITOS.NETWORK yarn/jupyter@DEITOS.NETWORK yarn/metastore@DEITOS.NETWORK

xst -k mapred-unmerged.keytab mapred/master@DEITOS.NETWORK mapred/worker1@DEITOS.NETWORK mapred/worker2@DEITOS.NETWORK mapred/history@DEITOS.NETWORK mapred/jupyter@DEITOS.NETWORK mapred/metastore@DEITOS.NETWORK

xst -k HTTP.keytab HTTP/master@DEITOS.NETWORK HTTP/worker1@DEITOS.NETWORK HTTP/worker2@DEITOS.NETWORK HTTP/history@DEITOS.NETWORK HTTP/jupyter@DEITOS.NETWORK HTTP/metastore@DEITOS.NETWORK

ktutil 
rkt hdfs-unmerged.keytab 
rkt HTTP.keytab
wkt hdfs.keytab
clear

rkt mapred-unmerged.keytab 
rkt HTTP.keytab
wkt mapred.keytab
clear

rkt yarn-unmerged.keytab 
rkt HTTP.keytab
wkt yarn.keytab
clear

root

kinit -kt /home/jovyan/keytabs/hdfs.keytab hdfs/master@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hdfs/worker1@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hdfs/worker2@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hdfs/history@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hdfs/jupyter@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hdfs/metastore@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hive/master@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hive/worker1@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hive/worker2@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hive/history@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hive/jupyter@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/hdfs.keytab hive/metastore@DEITOS.NETWORK 

kinit -kt /home/jovyan/keytabs/yarn.keytab yarn/master@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/yarn.keytab yarn/worker1@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/yarn.keytab yarn/worker2@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/yarn.keytab yarn/history@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/yarn.keytab yarn/jupyter@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/yarn.keytab yarn/metastore@DEITOS.NETWORK 

kinit -kt /home/jovyan/keytabs/mapred.keytab mapred/master@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/mapred.keytab mapred/worker1@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/mapred.keytab mapred/worker2@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/mapred.keytab mapred/history@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/mapred.keytab mapred/jupyter@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/mapred.keytab mapred/metastore@DEITOS.NETWORK 

kinit -kt /home/jovyan/keytabs/HTTP.keytab HTTP/master@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/HTTP.keytab HTTP/worker1@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/HTTP.keytab HTTP/worker2@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/HTTP.keytab HTTP/history@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/HTTP.keytab HTTP/jupyter@DEITOS.NETWORK 
kinit -kt /home/jovyan/keytabs/HTTP.keytab HTTP/metastore@DEITOS.NETWORK 

kadmin -p hadoop/admin@DEITOS.NETWORK -w deitos addprinc -pw admin user/admin@DEITOS.NETWORK

kadmin -p root/admin@DEITOS.NETWORK -w admin addprinc -pw admin jovyan/admin@DEITOS.NETWORK


kadmin -p root/admin@DEITOS.NETWORK -w admin addprinc -pw admin hdfs/master@DEITOS.NETWORK
kadmin -p root/admin@DEITOS.NETWORK -w admin addprinc -pw admin hive/master@DEITOS.NETWORK
kadmin -p root/admin@DEITOS.NETWORK -w admin addprinc -pw admin mapred/master@DEITOS.NETWORK
kadmin -p root/admin@DEITOS.NETWORK -w admin addprinc -pw admin yarn/master@DEITOS.NETWORK
kadmin -p root/admin@DEITOS.NETWORK -w admin addprinc -pw admin HTTP/master@DEITOS.NETWORK


sudo apt-get update
sudo apt-get install net-tools iputils-ping
netstat -tnlpa | grep 8020

kadmin -p jovyan/admin -w admin -q "addprinc -pw admin hdfs/master@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin hdfs/worker1@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin hdfs/worker2@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin hdfs/history@DEITOS.NETWORK"

kadmin -p jovyan/admin -w admin -q "addprinc -pw admin HTTP/master@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin HTTP/worker1@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin HTTP/worker2@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin HTTP/history@DEITOS.NETWORK"

kadmin -p jovyan/admin -w admin -q "addprinc -pw admin yarn/master@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin yarn/worker1@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin yarn/worker2@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin yarn/history@DEITOS.NETWORK"

kadmin -p jovyan/admin -w admin -q "addprinc -pw admin mapred/master@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin mapred/worker1@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin mapred/worker2@DEITOS.NETWORK" 
kadmin -p jovyan/admin -w admin -q "addprinc -pw admin mapred/history@DEITOS.NETWORK"

kadmin -p jovyan/admin -w admin -q " xst -k /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab hdfs/master@DEITOS.NETWORK hdfs/worker1@DEITOS.NETWORK hdfs/worker2@DEITOS.NETWORK hdfs/history@DEITOS.NETWORK hdfs/jupyter@DEITOS.NETWORK hdfs/metastore@DEITOS.NETWORK HTTP/master@DEITOS.NETWORK HTTP/worker1@DEITOS.NETWORK HTTP/worker2@DEITOS.NETWORK HTTP/history@DEITOS.NETWORK HTTP/jupyter@DEITOS.NETWORK HTTP/metastore@DEITOS.NETWORK "
kadmin -p jovyan/admin -w admin -q " xst -k /opt/hadoop/etc/hadoop/keytabs/yarn.keytab yarn/master@DEITOS.NETWORK yarn/worker1@DEITOS.NETWORK yarn/worker2@DEITOS.NETWORK yarn/history@DEITOS.NETWORK  yarn/jupyter@DEITOS.NETWORK  yarn/metastore@DEITOS.NETWORK"
kadmin -p jovyan/admin -w admin -q " xst -k /opt/hadoop/etc/hadoop/keytabs/mapred.keytab  mapred/master@DEITOS.NETWORK mapred/worker1@DEITOS.NETWORK mapred/worker2@DEITOS.NETWORK mapred/history@DEITOS.NETWORK mapred/jupyter@DEITOS.NETWORK mapred/metastore@DEITOS.NETWORK"


kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab hdfs/master@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab hdfs/worker1@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab hdfs/worker2@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab hdfs/history@DEITOS.NETWORK

kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab HTTP/master@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab HTTP/worker1@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab HTTP/worker2@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/hdfs.keytab HTTP/history@DEITOS.NETWORK

kinit -kt /opt/hadoop/etc/hadoop/keytabs/yarn.keytab yarn/master@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/yarn.keytab yarn/worker1@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/yarn.keytab yarn/worker2@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/yarn.keytab yarn/history@DEITOS.NETWORK


kinit -kt /opt/hadoop/etc/hadoop/keytabs/mapred.keytab mapred/master@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/mapred.keytab mapred/worker1@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/mapred.keytab mapred/worker2@DEITOS.NETWORK
kinit -kt /opt/hadoop/etc/hadoop/keytabs/mapred.keytab mapred/history@DEITOS.NETWORK

-----------------------------------------------------------------------------------

kadmin -p admin/admin -w admin -q "addprinc -randkey reimon"
kadmin -p admin/admin -w admin -q "xst -k $HOME/current.keytab reimon"

kinit -kt $HOME/current.keytab reimon

docker image prune -a

ldap 
https://localhost:20443
cn=admin,dc=deitos,dc=network
admin

-----------------------------------------------------------------------------------------------------------------------------------------

# kadmin -p admin/admin -w admin -q "addprinc -randkey ramon"
kadmin -p admin/admin -w admin -q "xst -k $HOME/current.keytab ramon"

kinit -kt $HOME/current.keytab ramon

-----------------------------------------------------------------------------------------------------------------------------------------

kinit -kt ~/current.keytab ramon && {
  token=`curl -s --insecure --negotiate -u : "https://master.deitos.network:50470/webhdfs/v1/?op=GETDELEGATIONTOKEN"`
  token=`echo $token | grep -Po 'urlString":"\K[^"]*'`
  kdestroy
  curl -s --insecure  "https://master.deitos.network:50470/webhdfs/v1/data/ramon?delegation=${token}&op=LISTSTATUS"
}

-----------------------------------------------------------------------------------------------------------------------------------------

kinit ramon

curl -v -i -k --negotiate -u : "https://master.deitos.network:50470/webhdfs/v1/?op=GETDELEGATIONTOKEN"

curl -v -i -k "https://master.deitos.network:50470/webhdfs/v1/?delegation=HgAFcmFtb24FcmFtb24AigGMV9Tl74oBjHvhae85VBQqR2NclnfeiAO9HJ_FQqHDW5E_RBNTV0VCSERGUyBkZWxlZ2F0aW9uDzE3Mi4yOC4xLjI6ODAyMA&op=LISTSTATUS"

curl -v -i -k --negotiate -u : -X PUT "https://master.deitos.network:50470/webhdfs/v1/data/ramon/people.csv?delegation=HgAFcmFtb24FcmFtb24AigGMV9Tl74oBjHvhae85VBQqR2NclnfeiAO9HJ_FQqHDW5E_RBNTV0VCSERGUyBkZWxlZ2F0aW9uDzE3Mi4yOC4xLjI6ODAyMA&op=CREATE"

curl -i -k -X PUT -T /opt/spark/examples/src/main/resources/people.csv "https://worker1.deitos.network:50075/webhdfs/v1/data/ramon/people.csv?op=CREATE&delegation=HgAFcmFtb24FcmFtb24AigGMV9Tl74oBjHvhae85VBQqR2NclnfeiAO9HJ_FQqHDW5E_RBNTV0VCSERGUyBkZWxlZ2F0aW9uDzE3Mi4yOC4xLjI6ODAyMA&namenoderpcaddress=master.deitos.network:8020&createflag=&createparent=true&overwrite=true"

-----------------------------------------------------------------------------------------------------------------------------------------

spark = SparkSession.builder\
    .config("spark.sql.warehouse.dir","hdfs://master.deitos.network:9000/data/deitos/hive/warehouse")\
    .enableHiveSupport()\
    .getOrCreate()
